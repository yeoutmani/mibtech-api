name: CI/CD

on:
    push:
        branches:
            - main
    pull_request: ~
    workflow_dispatch: ~

permissions:
    contents: read

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: true

jobs:
    ########################################################################
    # ðŸ§ª TESTS (CI)
    ########################################################################
    tests:
        name: Tests
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v5
              with:
                  persist-credentials: false

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker images
              uses: docker/bake-action@v6
              with:
                  pull: true
                  load: true
                  source: .
                  files: |
                      compose.yaml
                      compose.override.yaml
                  set: |
                      *.cache-from=type=gha,scope=${{ github.ref }}
                      *.cache-from=type=gha,scope=refs/heads/main
                      *.cache-to=type=gha,scope=${{ github.ref }},mode=max

            - name: Start services
              run: docker compose up --wait --no-build

            - name: Check HTTP reachability
              run: curl -v --fail-with-body http://localhost

            - name: Check Mercure
              run: curl -vI --insecure --fail-with-body https://localhost/.well-known/mercure?topic=test

            - name: Create DB
              run: docker compose exec -T php bin/console doctrine:database:create --env=test

            - name: Run migrations
              run: docker compose exec -T php bin/console doctrine:migrations:migrate --env=test --no-interaction

            - name: PHPUnit
              run: docker compose exec -T -e APP_ENV=test php bin/phpunit

            - name: Doctrine Schema Validator
              run: docker compose exec -T php bin/console doctrine:schema:validate --env=test

    ########################################################################
    # ðŸ” LINT
    ########################################################################
    lint:
        name: Lint
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: read
            statuses: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v5
              with:
                  fetch-depth: 0
                  persist-credentials: false

            - name: Super-Linter
              uses: super-linter/super-linter@v8
              env:
                  VALIDATE_ALL_CODEBASE: false
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  VALIDATE_EDITORCONFIG: false
                  FIX_BIOME_FORMAT: false
                  VALIDATE_BIOME_FORMAT: false
                  VALIDATE_PHP: false
                  VALIDATE_PHP_BUILTIN: false
                  VALIDATE_PHP_PHPCS: false
                  VALIDATE_PHP_PSALM: false
                  VALIDATE_PHP_PHPSTAN: false
                  VALIDATE_PHP_PHP_CS_FIXER: false
                  VALIDATE_JSCPD: false

    ########################################################################
    # ðŸ§¹ PHP CS Fixer
    ########################################################################
    php-cs-fixer:
        name: PHP CS Fixer
        runs-on: ubuntu-latest
        needs: lint

        steps:
            - name: Checkout code
              uses: actions/checkout@v5
              with:
                  persist-credentials: false

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.4"

            - name: Composer install
              run: composer install --no-interaction --no-scripts

            - name: PHP CS Fixer
              run: vendor/bin/php-cs-fixer fix --dry-run --diff

    ########################################################################
    # ðŸš€ DEPLOY TO PRODUCTION (CD)
    ########################################################################
    deploy:
        name: Deploy to Production
        needs: [tests, lint, php-cs-fixer]
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/heads/')

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  persist-credentials: false

            - name: Deploy to server via SSH
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.IO_ADDRESS }}
                  username: ${{ secrets.SSH_USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  script: |
                      cd /opt/mibtech-api
                      sudo docker compose down
                      rm -rf ~/mibtech-api-deploy
                      mkdir -p ~/mibtech-api-deploy
                      sudo find /opt/mibtech-api -maxdepth 1 -type f ! -name '.env*' ! -name 'docker-compose.yml' -delete
                      sudo rm -rf /opt/mibtech-api/src /opt/mibtech-api/config /opt/mibtech-api/public /opt/mibtech-api/var /opt/mibtech-api/vendor

            - name: Copy files
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.IO_ADDRESS }}
                  username: ${{ secrets.SSH_USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  source: ".,!.git,!.github,!var,!vendor"
                  target: "~/mibtech-api-deploy"
                  overwrite: true

            - name: Create .env file
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.IO_ADDRESS }}
                  username: ${{ secrets.SSH_USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  script: |
                      cat > ~/mibtech-api-deploy/.env << 'EOF'
                      APP_ENV=prod
                      EOF

            - name: Move files & restart Docker
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.IO_ADDRESS }}
                  username: ${{ secrets.SSH_USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  script: |
                      sudo mkdir -p /opt/mibtech-api
                      sudo cp -r ~/mibtech-api-deploy/* /opt/mibtech-api/
                      ls -l /opt/mibtech-api
                      # VÃ©rification et copie du .env si absent
                      if [ ! -f /opt/mibtech-api/.env ] && [ -f ~/mibtech-api-deploy/.env ]; then
                        echo ".env absent, copie depuis le dossier de dÃ©ploiement."
                        sudo cp ~/mibtech-api-deploy/.env /opt/mibtech-api/.env
                      fi
                      if [ -f /opt/mibtech-api/.env ]; then
                        echo ".env file found:"
                        cat /opt/mibtech-api/.env
                        sudo chmod 600 /opt/mibtech-api/.env
                        sudo chown root:root /opt/mibtech-api/.env
                      else
                        echo ".env file not found in /opt/mibtech-api"
                      fi
                      rm -rf ~/mibtech-api-deploy
                      cd /opt/mibtech-api
                      if command -v docker >/dev/null 2>&1; then
                        sudo docker compose up -d --build
                        sudo docker image prune -f
                        sleep 10
                        sudo docker compose ps
                        sudo docker compose logs --tail=50 php
                      else
                        echo "Docker is not installed or not in PATH"
                      fi
